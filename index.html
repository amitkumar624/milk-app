<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Milk Order</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Tailwind for quick styling -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="max-w-md mx-auto p-4 text-gray-800">

  <!-- Google Sign-In placeholder -->
  <div id="signin" class="flex justify-center my-6"></div>

  <!-- Order form -->
  <form id="orderForm" class="space-y-3 hidden">
    <select id="milkType" class="border p-2 w-full rounded"></select>

    <input type="date" id="forDate" class="border p-2 w-full rounded" />

    <input type="number" step="0.5" min="0.5" id="qty"
           placeholder="Litres (e.g. 1.5)" class="border p-2 w-full rounded" />

    <button class="bg-blue-600 hover:bg-blue-700 text-white w-full py-2 rounded">
      Place / Update order
    </button>
  </form>

  <!-- Table of current-month orders -->
  <table id="orderTable" class="w-full text-sm mt-8 hidden">
    <thead>
      <tr class="border-b font-medium">
        <th class="py-1 text-left">Date</th>
        <th class="py-1 text-left">Type</th>
        <th class="py-1 text-left">Qty (L)</th>
        <th class="py-1"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  /************  CONFIG – replace with your real values  ************/
  const CLIENT_ID = '986634454355-a7t356ndh593cs87qvpp9snht1fo9109.apps.googleusercontent.com';         // <–– from Google Cloud
  const API_URL   = 'https://script.google.com/macros/s/AKfycbxFB-ODONwlCC_dmPA0wakqajtYuc7OzfDaIKb3I6O8MgCQcsjRBR7fFZjM9JkS3OrO/exec';     // <–– ends with /exec
  /*****************************************************************/

  let idToken = '';

  const $form  = document.getElementById('orderForm');
  const $table = document.getElementById('orderTable').querySelector('tbody');
  const $select = document.getElementById('milkType');

  /* ---------- initial bootstrap ---------- */
  window.onload = () => {
    // 1) show Sign-In button
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleCred });
    google.accounts.id.renderButton(document.getElementById('signin'),
        { theme:'outline', size:'large' });

    // 2) fetch milk-type list even before login (public endpoint)
    loadMilkTypes();
  };

  /* ---------- Google Sign-In callback ---------- */
  function handleCred(resp){
    idToken = resp.credential;
    document.getElementById('signin').classList.add('hidden');
    $form.classList.remove('hidden');
    document.getElementById('orderTable').classList.remove('hidden');
    setMinDateToday();
    loadOrdersThisMonth();
  }

  /* ---------- helpers ---------- */
  function yyyyMm(){ return new Date().toISOString().slice(0,7); }
  function setMinDateToday(){
    document.getElementById('forDate').min = new Date().toISOString().slice(0,10);
  }
  function toast(msg){ alert(msg); }

  /* ---------- populate milk-type dropdown ---------- */
  function loadMilkTypes(){
    fetch(API_URL + '?meta=prices')
      .then(r => r.json())
      .then(rows => {
        const types = rows.slice(1).map(r => r[0]); // skip header row
        $select.innerHTML = '';
        types.forEach(t => {
          const o = document.createElement('option');
          o.textContent = t;
          $select.appendChild(o);
        });
      })
      .catch(err => console.error('Failed to load milk types:', err));
  }

  /* ---------- load & render this-month orders ---------- */
  async function loadOrdersThisMonth(){
    $table.innerHTML = '';
    const res = await fetch(`${API_URL}?idToken=${encodeURIComponent(idToken)}&month=${yyyyMm()}`);
    const rows = await res.json();
    rows.forEach(([id, , type, qty, date, status]) => {
      if(status !== 'ACTIVE') return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="py-1">${date}</td>
        <td>${type}</td>
        <td>${qty}</td>
        <td><button data-id="${id}" class="text-red-600">✕</button></td>`;
      $table.appendChild(tr);
    });
  }

  /* ---------- new / cancel ---------- */
  $form.addEventListener('submit', async e => {
    e.preventDefault();
    const body = {
      action   : 'NEW',
      idToken  : idToken,
      milkType : $select.value,
      qty      : Number(document.getElementById('qty').value),
      forDate  : document.getElementById('forDate').value
    };
    const res = await fetch(API_URL, {
      method : 'POST',
      headers: { 'Content-Type':'application/json' },
      body   : JSON.stringify(body)
    });
    const j = await res.json();
    console.log('Server reply →', j);
    toast(j.ok ? 'Saved!' : j.error);
    if(j.ok) loadOrdersThisMonth();
    e.target.reset();
  });

  $table.parentElement.addEventListener('click', async e => {
    if(!e.target.dataset.id) return;
    if(!confirm('Cancel this order?')) return;
    const body = { action:'DEL', idToken, orderId:e.target.dataset.id };
    const res = await fetch(API_URL, {
      method : 'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body)
    });
    const j = await res.json();
    toast(j.ok ? 'Cancelled' : j.error);
    if(j.ok) loadOrdersThisMonth();
  });
  </script>
</body>
</html>
