<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Milk Order App</title>

  <!-- Google Identity Services for Web (sign‑in) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Quick utility CSS (Tailwind via CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="max-w-md mx-auto p-4 text-gray-800">

  <!-- Google Sign‑In button renders here -->
  <div id="signin" class="flex justify-center my-6"></div>

  <!-- Order form (hidden until user logs in) -->
  <form id="orderForm" class="space-y-3 hidden">
    <label class="block text-sm">Milk&nbsp;Type</label>
    <select id="milkType" class="border p-2 w-full rounded"></select>

    <label class="block text-sm">Date</label>
    <input type="date" id="forDate" class="border p-2 w-full rounded" required />

    <label class="block text-sm">Quantity (L)</label>
    <input type="number" step="0.5" min="0.5" id="qty" class="border p-2 w-full rounded" placeholder="e.g. 1.5" required />

    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-2 rounded">
      Place&nbsp;/&nbsp;Update Order
    </button>
  </form>

  <!-- List this‑month orders -->
  <table id="orderTable" class="w-full text-sm mt-8 hidden">
    <thead><tr class="border-b font-medium">
      <th class="py-1 text-left">Date</th>
      <th class="py-1 text-left">Type</th>
      <th class="py-1 text-left">Qty</th>
      <th class="py-1"></th>
    </tr></thead>
    <tbody></tbody>
  </table>

<script>
/********************  CONFIG  ********************/
const CLIENT_ID = '986634454355-a7t356ndh593cs87qvpp9snht1fo9109.apps.googleusercontent.com';   // ← Google Cloud OAuth client
const API_URL   = 'https://script.google.com/macros/s/AKfycbxFB-ODONwlCC_dmPA0wakqajtYuc7OzfDaIKb3I6O8MgCQcsjRBR7fFZjM9JkS3OrO/exec';   // ← ends with /exec
/**************************************************/

let idToken = '';
const $signin = document.getElementById('signin');
const $form   = document.getElementById('orderForm');
const $table  = document.getElementById('orderTable');
const $tbody  = $table.querySelector('tbody');
const $select = document.getElementById('milkType');

/* ------- initialise on page load ------- */
window.addEventListener('DOMContentLoaded', () => {
  // 1) Google Sign‑In button
  google.accounts.id.initialize({ client_id: CLIENT_ID, callback: onGoogleSignIn });
  google.accounts.id.renderButton($signin, { theme:'outline', size:'large' });
  // 2) populate milk types (public – no auth needed)
  fetch(`${API_URL}?meta=prices`).then(r=>r.json()).then(rows=>{
      rows.slice(1).forEach(r=>{ // skip header
        const opt = document.createElement('option');
        opt.textContent = r[0];
        $select.appendChild(opt);
      });
  }).catch(err=>console.error('Milk list load failed',err));
});

/* ------- Google token callback ------- */
function onGoogleSignIn(resp){
  idToken = resp.credential;
  $signin.classList.add('hidden');       // hide button
  $form.classList.remove('hidden');
  $table.classList.remove('hidden');
  document.getElementById('forDate').min = new Date().toISOString().slice(0,10);
  loadOrders();
}

/* ------- helper: yyyy‑MM current month ------- */
function currentMonth(){ return new Date().toISOString().slice(0,7); }

/* ------- load existing orders ------- */
async function loadOrders(){
  $tbody.innerHTML = '';
  const r = await fetch(`${API_URL}?idToken=${encodeURIComponent(idToken)}&month=${currentMonth()}`);
  const rows = await r.json();
  rows.forEach(([id,,type,qty,date,status])=>{
    if(status!=='ACTIVE') return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-1">${date}</td>
      <td>${type}</td>
      <td>${qty}</td>
      <td><button class="text-red-600" data-id="${id}">✕</button></td>`;
    $tbody.appendChild(tr);
  });
}

/* ------- submit (new order) ------- */
$form.addEventListener('submit', async evt => {
  evt.preventDefault();
  const payload = {
    action   : 'NEW',
    idToken  : idToken,
    milkType : $select.value,
    qty      : Number(document.getElementById('qty').value),
    forDate  : document.getElementById('forDate').value
  };
  try{
    const res = await fetch(API_URL, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    const json = await res.json();
    if(json.ok){ alert('Order saved'); loadOrders(); $form.reset(); }
    else       { alert('Error: '+json.error); }
  }catch(err){ alert('Network / server error'); console.error(err); }
});

/* ------- cancel order ------- */
$tbody.addEventListener('click', async evt => {
  const id = evt.target.dataset.id;
  if(!id) return;
  if(!confirm('Cancel this order?')) return;
  const res = await fetch(API_URL, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'DEL', idToken:idToken, orderId:id })
  });
  const json = await res.json();
  if(json.ok){ alert('Cancelled'); loadOrders(); }
  else       { alert('Error: '+json.error); }
});
</script>
</body>
</html>
