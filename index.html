<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Milk Orders</title>

  <!-- Google Identity button -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- quick Tailwind via CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="max-w-md mx-auto p-4 text-gray-800">

  <!-- 1) Sign-in button mounts here -->
  <div id="signin" class="flex justify-center my-6"></div>

  <!-- 2) Order form -->
  <form id="orderForm" class="space-y-3 hidden">
    <select id="milkType" class="border p-2 w-full rounded"></select>

    <input type="date"  id="forDate" class="border p-2 w-full rounded">
    <input type="number" step="0.5" min="0.5" id="qty"
           placeholder="Litres (e.g. 1.5)" class="border p-2 w-full rounded">

    <button class="bg-blue-600 hover:bg-blue-700 text-white w-full py-2 rounded">
      Place / Update order
    </button>
  </form>

  <!-- 3) This-month orders -->
  <table id="orderTable" class="w-full text-sm mt-8 hidden">
    <thead><tr class="border-b font-medium">
      <th class="py-1 text-left">Date</th>
      <th class="py-1 text-left">Type</th>
      <th class="py-1 text-left">Qty (L)</th>
      <th class="py-1"></th>
    </tr></thead>
    <tbody></tbody>
  </table>

  <!-- ===============  ALL JAVASCRIPT  =============== -->
  <script>
  /* ---------- CONFIG ---------- */
  const CLIENT_ID = 'YOUR_OAUTH_CLIENT_ID';             // ← replace
  const API_URL   = 'YOUR_SCRIPT_WEBAPP_URL';           // ← replace
  /* ---------------------------- */

  let idToken = '';

  const $signin = document.getElementById('signin');
  const $form   = document.getElementById('orderForm');
  const $table  = document.getElementById('orderTable');
  const $tbody  = $table.querySelector('tbody');
  const $milk   = document.getElementById('milkType');
  const $date   = document.getElementById('forDate');
  const $qty    = document.getElementById('qty');

  /* ========== 1. INITIALISE WHEN PAGE LOADS ========== */
  window.addEventListener('DOMContentLoaded', () => {
    /* 1-A  Google Sign-In */
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback : onGoogleSignIn
    });
    google.accounts.id.renderButton($signin, { theme:'outline', size:'large' });

    /* 1-B  populate milk dropdown from Prices sheet */
    fetch(API_URL + '?meta=prices')
      .then(r => r.json())
      .then(rows => {
        rows.slice(1).forEach(r => {           // skip header
          const o = document.createElement('option');
          o.textContent = r[0];
          $milk.appendChild(o);
        });
      })
      .catch(err => console.error('Dropdown load failed:', err));
  });

  /* -------- Google callback -------- */
  function onGoogleSignIn(resp){
    idToken = resp.credential;
    $signin.classList.add('hidden');
    $form.classList.remove('hidden');
    $table.classList.remove('hidden');

    $date.min = new Date().toISOString().slice(0,10);  // block past days
    loadOrders();
  }

  /* -------- helper: current YYYY-MM -------- */
  const thisMonth = () => new Date().toISOString().slice(0,7);

  /* ========== 2. FETCH & SHOW EXISTING ORDERS ========== */
  async function loadOrders(){
    $tbody.innerHTML='';
    const r = await fetch(`${API_URL}?idToken=${encodeURIComponent(idToken)}&month=${thisMonth()}`);
    const rows = await r.json();
    rows.forEach(([id,,type,qty,date,status])=>{
      if(status!=='ACTIVE') return;
      const tr = document.createElement('tr');
      tr.innerHTML=`
        <td class="py-1">${date}</td>
        <td>${type}</td>
        <td>${qty}</td>
        <td><button data-id="${id}" class="text-red-600">✕</button></td>`;
      $tbody.appendChild(tr);
    });
  }

  /* ========== 3. PLACE / UPDATE AN ORDER ========== */
  $form.addEventListener('submit', async evt=>{
    evt.preventDefault();
    const body = {
      action   :'NEW',
      idToken  : idToken,
      milkType : $milk.value,
      qty      : Number($qty.value),
      forDate  : $date.value
    };
    try{
      const res = await fetch(API_URL,{
        method :'POST',
        headers:{'Content-Type':'application/json'},
        body   : JSON.stringify(body)
      });
      const j = await res.json();
      console.log('Server reply →',j);
      alert(j.ok ? 'Order saved' : 'Error: '+j.error);
      if(j.ok){ $form.reset(); loadOrders(); }
    }catch(e){ alert('Network error'); console.error(e); }
  });

  /* ========== 4. CANCEL FROM TABLE ========== */
  $tbody.addEventListener('click', async evt=>{
    const id = evt.target.dataset.id;
    if(!id) return;
    if(!confirm('Cancel this order?')) return;
    const res = await fetch(API_URL,{
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   : JSON.stringify({ action:'DEL', idToken:idToken, orderId:id })
    });
    const j = await res.json();
    alert(j.ok ? 'Cancelled' : 'Error: '+j.error);
    if(j.ok) loadOrders();
  });
  </script>
  <!-- ============  END JAVASCRIPT  ============ -->

</body>
</html>
